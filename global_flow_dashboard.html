<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Flow Monitor v2.1</title>
<style>
  :root {
    --bg: #0a0e17;
    --surface: #111827;
    --surface2: #1a2235;
    --border: #1e293b;
    --text: #e2e8f0;
    --text-dim: #64748b;
    --text-muted: #475569;
    --red: #ef4444;
    --red-bg: #450a0a;
    --green: #22c55e;
    --green-bg: #052e16;
    --yellow: #eab308;
    --yellow-bg: #422006;
    --blue: #3b82f6;
    --blue-bg: #172554;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    background: var(--bg);
    color: var(--text);
    padding: 16px;
    min-height: 100vh;
  }

  /* â”€â”€ Header â”€â”€ */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 16px;
  }
  .header h1 { font-size: 18px; font-weight: 600; letter-spacing: -0.5px; }
  .header .meta { color: var(--text-dim); font-size: 11px; text-align: right; }
  .header .meta div { margin-top: 2px; }

  /* â”€â”€ Flow Scoreboard â”€â”€ */
  .flow-scoreboard {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }
  .flow-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    overflow: hidden;
  }
  .flow-panel-title {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .flow-panel-title.inflow { color: #4ade80; }
  .flow-panel-title.outflow { color: #f87171; }
  .flow-panel-title .count {
    font-size: 10px;
    font-weight: 400;
    color: var(--text-dim);
  }

  .flow-row {
    display: grid;
    grid-template-columns: 140px 1fr 110px;
    align-items: center;
    gap: 8px;
    padding: 7px 10px;
    border-radius: 4px;
    margin-bottom: 0;
    transition: transform 0.1s;
    cursor: pointer;
    user-select: none;
  }
  .flow-row:hover {
    transform: translateX(2px);
    filter: brightness(1.15);
  }
  .flow-row .expand-icon {
    font-size: 8px;
    color: var(--text-muted);
    transition: transform 0.2s;
    margin-right: 2px;
  }
  .flow-row .expand-icon.open { transform: rotate(90deg); }

  /* â”€â”€ Ticker Detail (inline expand) â”€â”€ */
  .ticker-expand {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    margin-bottom: 3px;
  }
  .ticker-expand.open { max-height: 600px; }
  .ticker-expand-inner {
    padding: 4px 8px 8px 20px;
    background: rgba(0,0,0,0.25);
    border-radius: 0 0 4px 4px;
    border-left: 2px solid var(--blue);
    margin-left: 10px;
    margin-right: 10px;
  }
  .ticker-expand-inner table { width: 100%; border-collapse: collapse; font-size: 10px; }
  .ticker-expand-inner th {
    text-align: left; padding: 2px 4px; color: var(--text-muted);
    font-size: 8px; text-transform: uppercase; letter-spacing: 0.3px; font-weight: 500;
  }
  .ticker-expand-inner th.r { text-align: right; }
  .ticker-expand-inner td { padding: 3px 4px; border-bottom: 1px solid rgba(255,255,255,0.04); }
  .ticker-expand-inner td.r { text-align: right; font-variant-numeric: tabular-nums; }
  .ticker-expand-inner td.tk { font-weight: 700; font-size: 11px; }
  .ticker-expand-inner td.nm { color: var(--text-dim); font-size: 9px; max-width: 110px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .flow-row .grp-label {
    font-size: 11px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .flow-row .grp-label .icon { margin-right: 4px; }
  .flow-row .pct-block {
    text-align: right;
  }
  .flow-row .pct-main {
    font-size: 15px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    line-height: 1.2;
  }
  .flow-row .est-flow {
    font-size: 10px;
    font-weight: 500;
    font-variant-numeric: tabular-nums;
    line-height: 1.2;
    opacity: 0.7;
  }
  .flow-row .est-flow.big {
    font-size: 11px;
    font-weight: 700;
    opacity: 1;
  }
  .flow-row .bar-wrap {
    height: 18px;
    background: rgba(255,255,255,0.03);
    border-radius: 3px;
    overflow: hidden;
    position: relative;
  }
  .flow-row .bar-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.4s ease;
  }
  /* â”€â”€ Top Movers Strip â”€â”€ */
  .top-movers {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    overflow-x: auto;
  }
  .top-movers-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-dim);
    white-space: nowrap;
    letter-spacing: 0.5px;
  }
  .mover-card {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    padding: 6px 10px;
    border-radius: 6px;
    min-width: 70px;
    text-align: center;
    flex-shrink: 0;
  }
  .mover-card .ticker {
    font-size: 12px;
    font-weight: 700;
  }
  .mover-card .pct {
    font-size: 11px;
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }
  .mover-card .name {
    font-size: 8px;
    color: rgba(255,255,255,0.5);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 80px;
  }
  .mover-spacer {
    color: var(--text-muted);
    font-size: 14px;
    padding: 0 4px;
    flex-shrink: 0;
  }

  /* â”€â”€ KPI Row â”€â”€ */
  .kpi-row {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }
  .kpi-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    text-align: center;
  }
  .kpi-label {
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    margin-bottom: 4px;
  }
  .kpi-value {
    font-size: 26px;
    font-weight: 700;
    line-height: 1;
  }
  .kpi-sub {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 3px;
  }
  .kpi-bar {
    height: 3px;
    background: var(--surface2);
    border-radius: 2px;
    margin-top: 6px;
    overflow: hidden;
  }
  .kpi-bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  /* â”€â”€ Signals â”€â”€ */
  .signals-bar {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    margin-bottom: 16px;
  }
  .signals-bar .title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-bottom: 10px;
  }
  .signal-card {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 6px;
    margin-bottom: 6px;
  }
  .signal-high { background: var(--red-bg); border-left: 3px solid var(--red); }
  .signal-med  { background: var(--yellow-bg); border-left: 3px solid var(--yellow); }
  .signal-low  { background: var(--green-bg); border-left: 3px solid var(--green); }
  .signal-icon { font-size: 18px; flex-shrink: 0; }
  .signal-text { font-size: 12px; line-height: 1.5; }
  .signal-text strong { display: block; margin-bottom: 2px; }
  .signal-text .detail { color: var(--text-dim); font-size: 10px; }

  /* â”€â”€ Category Detail (collapsible) â”€â”€ */
  .cat-detail-wrapper {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  .cat-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 14px;
    cursor: pointer;
    user-select: none;
  }
  .cat-detail-header:hover { background: var(--surface2); }
  .cat-detail-title {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
  }
  .cat-detail-toggle {
    font-size: 11px;
    color: var(--blue);
  }
  .cat-detail-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 0 14px 10px;
  }
  .cat-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
    font-variant-numeric: tabular-nums;
  }
  .cat-detail-body {
    overflow: hidden;
    transition: max-height 0.3s ease;
    max-height: 0;
  }
  .cat-detail-body.open { max-height: 3000px; }
  .cat-detail-inner {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    padding: 0 14px 14px;
  }

  .cat-card-inner { overflow: hidden; }
  .cat-card-inner .cat-label {
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 6px;
  }

  /* â”€â”€ Group sections inside detail â”€â”€ */
  .group-section { margin-bottom: 4px; }
  .group-header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 8px;
    background: var(--surface2);
    border-left: 3px solid var(--blue);
    border-radius: 0 4px 4px 0;
    cursor: pointer;
    user-select: none;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
  }
  .group-header:hover { background: #1f2b42; }
  .group-header .toggle-icon {
    font-size: 8px;
    transition: transform 0.2s;
    width: 10px;
  }
  .group-header .toggle-icon.open { transform: rotate(90deg); }
  .group-header .grp-avg {
    margin-left: auto;
    font-variant-numeric: tabular-nums;
    font-weight: 400;
  }
  .group-body { overflow: hidden; transition: max-height 0.25s ease; }

  /* â”€â”€ Ticker table â”€â”€ */
  .ticker-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .ticker-table th {
    text-align: left;
    padding: 4px;
    color: var(--text-muted);
    font-weight: 500;
    font-size: 9px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  .ticker-table th.num { text-align: right; }
  .ticker-table td {
    padding: 3px 4px;
    border-bottom: 1px solid #0f172a;
    font-variant-numeric: tabular-nums;
  }
  .ticker-table td.num { text-align: right; }
  .ticker-table td.ticker-name {
    color: var(--text-dim);
    font-size: 10px;
    max-width: 100px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* â”€â”€ Heatmap text colors â”€â”€ */
  .pos { color: #4ade80; }
  .neg { color: #f87171; }
  .neu { color: var(--text-dim); }

  .tag {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 8px;
    font-size: 9px;
    font-weight: 600;
  }
  .tag-red    { background: var(--red-bg); color: var(--red); }
  .tag-green  { background: var(--green-bg); color: var(--green); }
  .tag-yellow { background: var(--yellow-bg); color: var(--yellow); }

  /* â”€â”€ TE Flow rows â”€â”€ */
  .te-flow-row {
    display: grid;
    grid-template-columns: 220px 60px 40px 1fr;
    align-items: center;
    gap: 8px;
    padding: 5px 8px;
    border-radius: 4px;
    margin-bottom: 2px;
    font-size: 11px;
  }
  .te-flow-row:hover { background: var(--surface2); }
  .te-flow-row .te-dir { font-weight: 600; }
  .te-flow-row .te-z { font-weight: 700; font-variant-numeric: tabular-nums; text-align: right; }
  .te-flow-row .te-lag { color: var(--text-dim); font-size: 10px; text-align: center; }
  .te-flow-row .te-bar { height: 14px; border-radius: 3px; overflow: hidden; background: rgba(255,255,255,0.03); }
  .te-flow-row .te-bar-fill { height: 100%; border-radius: 3px; }

  /* â”€â”€ Bottom sections â”€â”€ */
  .bottom-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
  }
  .card-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-bottom: 10px;
  }
  .checklist { list-style: none; font-size: 12px; }
  .checklist li {
    padding: 6px 0;
    border-bottom: 1px solid #0f172a;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .checklist .time { color: var(--blue); font-size: 10px; min-width: 48px; }

  .link-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
  .link-item {
    display: block;
    padding: 8px 10px;
    background: var(--surface2);
    border-radius: 6px;
    color: var(--blue);
    text-decoration: none;
    font-size: 11px;
    transition: background 0.2s;
  }
  .link-item:hover { background: #243147; }
  .link-item .link-label {
    display: block;
    color: var(--text-dim);
    font-size: 9px;
    margin-top: 2px;
  }

  .full-width { grid-column: 1 / -1; }

  .note {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid var(--border);
    line-height: 1.6;
  }

  /* â”€â”€ Period Selector â”€â”€ */
  .period-selector {
    display: flex;
    gap: 4px;
    margin-bottom: 10px;
  }
  .period-btn {
    padding: 4px 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--surface);
    color: var(--text-dim);
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
  }
  .period-btn:hover { border-color: var(--blue); color: var(--text); }
  .period-btn.active { background: var(--blue); border-color: var(--blue); color: #fff; }

  /* â”€â”€ TE 4-grid â”€â”€ */
  .te-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .te-panel {
    background: rgba(0,0,0,0.15);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px;
  }
  .te-panel-title {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    margin-bottom: 6px;
  }
  .te-panel .te-flow-row { grid-template-columns: 180px 55px 35px 1fr; font-size: 10px; padding: 3px 4px; }
  .te-section-label {
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 6px 0 2px 0;
    padding-bottom: 2px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  /* â”€â”€ Buying Efficiency â”€â”€ */
  #buying-eff-card { margin-bottom: 16px; }

  /* â”€â”€ Response Matrix â”€â”€ */
  .matrix-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .matrix-table th {
    text-align: left;
    padding: 6px 4px;
    color: var(--text-dim);
    font-weight: 500;
    font-size: 9px;
    text-transform: uppercase;
    border-bottom: 1px solid var(--border);
  }
  .matrix-table td {
    padding: 6px 4px;
    border-bottom: 1px solid #0f172a;
  }

  /* â”€â”€ Responsive â”€â”€ */
  @media (max-width: 768px) {
    .flow-scoreboard { grid-template-columns: 1fr; }
    .flow-row { grid-template-columns: 120px 1fr 90px; }
    .cat-detail-inner { grid-template-columns: 1fr; }
    .bottom-grid, .link-grid { grid-template-columns: 1fr; }
    .kpi-row { grid-template-columns: repeat(3, 1fr); }
    .top-movers { flex-wrap: wrap; }
  }
  @media (max-width: 480px) {
    .kpi-row { grid-template-columns: 1fr 1fr; }
    .flow-row { grid-template-columns: 100px 1fr 80px; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <h1>ğŸ“¡ Global Flow Monitor <span style="font-size:11px;color:var(--text-dim)">v2.1</span></h1>
  <div class="meta">
    <div id="timestamp"></div>
    <div id="data-date"></div>
  </div>
</div>

<!-- PERIOD SELECTOR + FLOW SCOREBOARD -->
<div class="period-selector" id="period-selector">
  <button class="period-btn" data-period="d1" data-key="1D %">1D</button>
  <button class="period-btn active" data-period="d5" data-key="1W %">1W</button>
  <button class="period-btn" data-period="d30" data-key="1M %">1M</button>
  <button class="period-btn" data-period="d90" data-key="3M %">3M</button>
  <button class="period-btn" data-period="d180" data-key="6M %">6M</button>
  <button class="period-btn" data-period="d365" data-key="1Y %">1Y</button>
</div>
<div class="flow-scoreboard">
  <div class="flow-panel" id="inflow-panel">
    <div class="flow-panel-title inflow">ğŸ”º GAINERS (1W+) <span class="count" id="inflow-count"></span></div>
    <div id="inflow-rows"></div>
  </div>
  <div class="flow-panel" id="outflow-panel">
    <div class="flow-panel-title outflow">ğŸ”» LOSERS (1W-) <span class="count" id="outflow-count"></span></div>
    <div id="outflow-rows"></div>
  </div>
</div>

<!-- TOP MOVERS STRIP -->
<div class="top-movers" id="top-movers"></div>

<!-- KPI CARDS -->
<div class="kpi-row">
  <div class="kpi-card">
    <div class="kpi-label">Rotation Score</div>
    <div class="kpi-value" id="kpi-rot">--</div>
    <div class="kpi-sub" id="kpi-rot-sub">Defensive - Semi 5D</div>
    <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi-rot-bar"></div></div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">EWY vs EEM (1W)</div>
    <div class="kpi-value" id="kpi-em">--</div>
    <div class="kpi-sub" id="kpi-em-sub">í•œêµ­ vs EM ê´‘ì—­</div>
    <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi-em-bar"></div></div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">VIX</div>
    <div class="kpi-value" id="kpi-vix">--</div>
    <div class="kpi-sub" id="kpi-vix-sub">ì‹œì¥ ê³µí¬ ì§€ìˆ˜</div>
    <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi-vix-bar"></div></div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Credit Spread</div>
    <div class="kpi-value" id="kpi-credit">--</div>
    <div class="kpi-sub" id="kpi-credit-sub">HYG - LQD 1W</div>
    <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi-credit-bar"></div></div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">US Exceptionalism</div>
    <div class="kpi-value" id="kpi-usex">--</div>
    <div class="kpi-sub" id="kpi-usex-sub">SPY - EFA 1W</div>
    <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi-usex-bar"></div></div>
  </div>
</div>

<!-- COMPOSITE SIGNALS -->
<div class="signals-bar">
  <div class="title">ğŸš¨ ë³µí•© ì‹œê·¸ë„ -- ì™¸ì¸ í–‰ë™ ì˜ˆì¸¡</div>
  <div id="signals"></div>
</div>

<!-- GROUP TE (Transfer Entropy) â€” 4-window grid -->
<div class="card" id="group-te-card" hidden style="margin-bottom:16px">
  <div class="card-title">ğŸ”— ê·¸ë£¹ ê°„ ì •ë³´ íë¦„ (Transfer Entropy)</div>
  <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px">Aâ†’B: Aê°€ Bì— ì„ í–‰. <span style="color:#60a5fa">Price</span>=ê°€ê²© ìˆ˜ìµë¥  ì „ì´ <span style="color:#22d3ee">Flow</span>=ê±°ë˜ëŒ€ê¸ˆ(CloseÃ—Vol) íë¦„ ì „ì´. Z>2.5 ìœ ì˜ë¯¸.</div>
  <div class="te-grid" id="group-te-grid"></div>
</div>

<!-- CATEGORY DETAIL (collapsed by default) -->
<div id="cat-detail-section"></div>

<!-- BUYING EFFICIENCY -->
<div class="card" id="buying-eff-card" hidden>
  <div class="card-title">ê°œì¸ ë§¤ìˆ˜ íš¨ìœ¨ (Buying Efficiency)</div>
  <div id="buying-eff-content" style="font-size:12px; line-height:1.8;"></div>
</div>

<!-- BOTTOM: Checklist, Links, Response Matrix -->
<div class="bottom-grid">
  <div class="card">
    <div class="card-title">ë§¤ì¼ ì•„ì¹¨ ì²´í¬ë¦¬ìŠ¤íŠ¸</div>
    <ul class="checklist">
      <li><span class="time">08:00</span> ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ -> Flow Scoreboard í™•ì¸</li>
      <li><span class="time">08:03</span> OUTFLOW íŒ¨ë„ -> ìê¸ˆ ì´íƒˆ ë°©í–¥</li>
      <li><span class="time">08:05</span> VIX + Credit Spread -> ë¦¬ìŠ¤í¬ í™˜ê²½</li>
      <li><span class="time">08:07</span> US Exceptionalism -> EM ì••ë ¥ ì—¬ë¶€</li>
      <li><span class="time">08:10</span> ë³µí•© ì‹œê·¸ë„ ì´ìƒ ì‹œ ë‰´ìŠ¤ ë§¥ë½ í™•ì¸</li>
      <li><span class="time">08:15</span> í•œêµ­ ìˆ˜ê¸‰ ëŒ€ì… -> ì‹œë‚˜ë¦¬ì˜¤ ì •ë¦¬</li>
      <li><span class="time">15:30</span> ì¥ë§ˆê° í›„ ë§¤ìˆ˜ íš¨ìœ¨ ê¸°ë¡</li>
    </ul>
  </div>
  <div class="card">
    <div class="card-title">í•µì‹¬ ì†ŒìŠ¤ ë°”ë¡œê°€ê¸°</div>
    <div class="link-grid">
      <a class="link-item" href="https://www.morningstar.com/funds/etf-fund-flows" target="_blank">
        Morningstar ETF Flows
        <span class="link-label">ì›”ê°„ ì„¹í„°/ì§€ì—­ë³„</span>
      </a>
      <a class="link-item" href="https://www.etf.com/etfanalytics/etf-fund-flows-tool" target="_blank">
        ETF.com Flow Tool
        <span class="link-label">ì¼ê°„ ê°œë³„ ETF</span>
      </a>
      <a class="link-item" href="https://www.ici.org/research/stats/combined_flows" target="_blank">
        ICI Combined Flows
        <span class="link-label">ì£¼ê°„ ë®¤ì¶”ì–¼+ETF</span>
      </a>
      <a class="link-item" href="https://www.cfr.org/global-conflict-tracker" target="_blank">
        CFR Conflict Tracker
        <span class="link-label">ì§€ì •í•™ ë¦¬ìŠ¤í¬</span>
      </a>
      <a class="link-item" href="https://www.cmegroup.com/markets/interest-rates/cme-fedwatch-tool.html" target="_blank">
        CME FedWatch
        <span class="link-label">ê¸ˆë¦¬ ì¸í•˜ í™•ë¥ </span>
      </a>
      <a class="link-item" href="https://www.marketscreener.com" target="_blank">
        MarketScreener
        <span class="link-label">ê¸€ë¡œë²Œ í€ë“œí”Œë¡œìš°</span>
      </a>
    </div>
  </div>
</div>

<!-- Response Matrix -->
<div class="card" style="margin-bottom:16px">
  <div class="card-title">ì´ìƒ ì‹ í˜¸ ëŒ€ì‘ ë§¤íŠ¸ë¦­ìŠ¤</div>
  <table class="matrix-table">
    <thead>
      <tr><th>ë³µí•© ì‹œê·¸ë„</th><th>ìœ„í—˜ë„</th><th>ì¦‰ê° í–‰ë™</th><th>ì´ì „ ì‚¬ë¡€</th></tr>
    </thead>
    <tbody>
      <tr>
        <td>ë¡œí…Œì´ì…˜ +5 & ë‹¬ëŸ¬ +1.5%</td>
        <td><span class="tag tag-red">HIGH</span></td>
        <td>í•œêµ­ ë°˜ë„ì²´ í¬ì§€ì…˜ ì¬ê²€í† </td>
        <td style="color:var(--text-dim)">2026.1.20 ê´€ì„¸ ì‡¼í¬</td>
      </tr>
      <tr>
        <td>HYG-LQD ìŠ¤í”„ë ˆë“œ -1.5%</td>
        <td><span class="tag tag-red">HIGH</span></td>
        <td>í˜„ê¸ˆ ë¹„ì¤‘ í™•ëŒ€, ìœ„í—˜ìì‚° ì¶•ì†Œ</td>
        <td style="color:var(--text-dim)">í¬ë ˆë”§ ìŠ¤íŠ¸ë ˆìŠ¤</td>
      </tr>
      <tr>
        <td>ê¸ˆ+ìœ ê°€ ë™ì‹œ +3%</td>
        <td><span class="tag tag-red">HIGH</span></td>
        <td>ë°©ì–´ì£¼ ì „í™˜, TLT/UUP êµì°¨ í™•ì¸</td>
        <td style="color:var(--text-dim)">2025.6 ì´ë€-ì´ìŠ¤ë¼ì—˜</td>
      </tr>
      <tr>
        <td>VIX 30+ & ì—” +3%</td>
        <td><span class="tag tag-red">HIGH</span></td>
        <td>ì „ë©´ ë””ë ˆë²„ë¦¬ì§€</td>
        <td style="color:var(--text-dim)">2024.8 ìºë¦¬ ì²­ì‚°</td>
      </tr>
      <tr>
        <td>SPY vs EFA +3%</td>
        <td><span class="tag tag-yellow">MED</span></td>
        <td>EM ë¹„ì¤‘ ì¶•ì†Œ ê²€í† </td>
        <td style="color:var(--text-dim)">US Exceptionalism</td>
      </tr>
      <tr>
        <td>EWY vs EEM -4%</td>
        <td><span class="tag tag-yellow">MED</span></td>
        <td>ì™¸ì¸ ì„ ë¬¼ ìˆ ê·œëª¨ í™•ì¸</td>
        <td style="color:var(--text-dim)">2026.2.5 ì™¸ì¸ 5ì¡° ë§¤ë„</td>
      </tr>
    </tbody>
  </table>
</div>

<div class="note" id="footer-note">
  ë°ì´í„° ì—°ë™: <code>python global_flow_monitor.py</code> ì‹¤í–‰ í›„ ìƒˆë¡œê³ ì¹¨ (ìë™ export)<br>
  ë°ì´í„° ì†ŒìŠ¤: Yahoo Finance (15ë¶„ ì§€ì—°) + KRX (pykrx)<br>
  v2.2 -- ê·¸ë£¹ í´ë¦­ â†’ í•˜ìœ„ í‹°ì»¤ í¼ì¹˜ê¸° + 1D/1W/1M/3M/6M/1Y ì‹œê³„ì—´
</div>

<script>
// =====================================================
// Global Flow Monitor v2.1 -- Dashboard JS
// =====================================================

// â”€â”€ Enhanced Heatmap Color â”€â”€
function heatColor(value, maxAbs) {
  maxAbs = maxAbs || 5;
  if (value == null || isNaN(value)) return 'rgba(100,116,139,0.1)';
  const i = Math.min(Math.abs(value) / maxAbs, 1);
  if (Math.abs(value) < 0.15) return 'rgba(100,116,139,0.1)'; // neutral slate
  if (value > 0) {
    // green: hsl(152, 50+i*40, 14+i*22)
    const sat = 50 + i * 40;
    const light = 14 + i * 22;
    return `hsl(152, ${sat}%, ${light}%)`;
  } else {
    // red: hsl(4, 50+i*40, 14+i*22)
    const sat = 50 + i * 40;
    const light = 14 + i * 22;
    return `hsl(4, ${sat}%, ${light}%)`;
  }
}

function barColor(value, maxAbs) {
  maxAbs = maxAbs || 5;
  const i = Math.min(Math.abs(value) / maxAbs, 1);
  if (value > 0) {
    return `hsla(152, ${60 + i*30}%, ${35 + i*25}%, ${0.4 + i*0.4})`;
  } else {
    return `hsla(4, ${60 + i*30}%, ${35 + i*25}%, ${0.4 + i*0.4})`;
  }
}

function textColor(value, maxAbs) {
  maxAbs = maxAbs || 5;
  if (value == null || isNaN(value)) return 'var(--text-dim)';
  if (Math.abs(value) < 0.15) return 'var(--text-dim)';
  const i = Math.min(Math.abs(value) / maxAbs, 1);
  if (Math.abs(value) > 3) return '#ffffff';
  return value > 0 ? '#4ade80' : '#f87171';
}

function fmtPct(v) {
  if (v == null || isNaN(v)) return '<span class="neu">--</span>';
  const cls = v > 0.05 ? 'pos' : v < -0.05 ? 'neg' : 'neu';
  return `<span class="${cls}">${v > 0 ? '+' : ''}${v.toFixed(1)}%</span>`;
}

function fmtPctPlain(v) {
  if (v == null || isNaN(v)) return '--';
  return `${v > 0 ? '+' : ''}${v.toFixed(1)}`;
}

// â”€â”€ Format dollar amount â”€â”€
function fmtDollar(v) {
  if (v == null || isNaN(v) || v === 0) return '--';
  const abs = Math.abs(v);
  const sign = v > 0 ? '+' : '-';
  if (abs >= 1e9) return `${sign}$${(abs/1e9).toFixed(1)}B`;
  if (abs >= 1e6) return `${sign}$${Math.round(abs/1e6)}M`;
  if (abs >= 1e3) return `${sign}$${Math.round(abs/1e3)}K`;
  return `${sign}$${Math.round(abs)}`;
}

// â”€â”€ Collect all groups with 1W% for scoreboard â”€â”€
function collectGroups(categories) {
  const groups = [];
  const EXCLUDE_GROUPS = ['Volatility']; // VIX shown separately in KPI

  for (const [catKey, cat] of Object.entries(categories)) {
    const summary = cat.summary || {};
    const grpData = cat.groups || {};
    for (const [grpName, vals] of Object.entries(summary)) {
      if (EXCLUDE_GROUPS.includes(grpName)) continue;
      groups.push({
        name: grpName,
        icon: cat.icon || '',
        catLabel: cat.label || '',
        d1: vals['1D %'] ?? 0,
        d5: vals['1W %'] ?? 0,
        d30: vals['1M %'] ?? 0,
        d90: vals['3M %'] ?? null,
        d180: vals['6M %'] ?? null,
        d365: vals['1Y %'] ?? null,
        tradingImpact: vals['trading_impact'] ?? 0,
        avgDolVol: vals['avg_dol_vol'] ?? 0,
        tickers: grpData[grpName] || [],
      });
    }
  }
  return groups;
}

// â”€â”€ Format AUM â”€â”€
function fmtAum(v) {
  if (v == null || isNaN(v) || v === 0) return '';
  const abs = Math.abs(v);
  if (abs >= 1e9) return `$${(abs/1e9).toFixed(1)}B`;
  if (abs >= 1e6) return `$${Math.round(abs/1e6)}M`;
  if (abs >= 1e3) return `$${Math.round(abs/1e3)}K`;
  return `$${Math.round(abs)}`;
}

// â”€â”€ Build ticker detail table HTML â”€â”€
function buildTickerTable(tickers) {
  if (!tickers || tickers.length === 0) return '';
  const cols = ['1D %','1W %','1M %','3M %','6M %','1Y %'];
  const labels = ['1D','1W','1M','3M','6M','1Y'];
  let html = '<table><thead><tr><th>Ticker</th><th>Name</th>';
  labels.forEach(l => { html += `<th class="r">${l}</th>`; });
  html += '<th class="r">DailyVol</th></tr></thead><tbody>';
  tickers.forEach(t => {
    html += `<tr>`;
    html += `<td class="tk">${t.Ticker||''}</td>`;
    html += `<td class="nm">${t.Name||''}</td>`;
    cols.forEach(c => {
      const v = t[c];
      const cls = v > 0.05 ? 'pos' : v < -0.05 ? 'neg' : 'neu';
      const bold = Math.abs(v||0) > 5 ? 'font-weight:700;' : '';
      html += `<td class="r"><span class="${cls}" style="${bold}">${v != null ? (v > 0 ? '+' : '') + v.toFixed(1) + '%' : '--'}</span></td>`;
    });
    html += `<td class="r" style="color:var(--text-muted);font-size:9px">${fmtAum(t.AvgDolVol)}</td>`;
    html += '</tr>';
  });
  html += '</tbody></table>';
  return html;
}

// â”€â”€ Flow Scoreboard (period-switchable) â”€â”€
let _cachedGroups = [];
let _currentPeriod = 'd5';
const PERIOD_MAP = {d1:'d1', d5:'d5', d30:'d30', d90:'d90', d180:'d180', d365:'d365'};
const PERIOD_LABELS = {d1:'1D', d5:'1W', d30:'1M', d90:'3M', d180:'6M', d365:'1Y'};

function renderFlowScoreboard(categories, period) {
  period = period || _currentPeriod;
  _currentPeriod = period;
  const groups = _cachedGroups.length ? _cachedGroups : collectGroups(categories);
  if (categories) _cachedGroups = groups;
  if (groups.length === 0) return;

  // Get value for current period
  function getVal(g) {
    return g[period] ?? 0;
  }

  const maxAbs = Math.max(...groups.map(g => Math.abs(getVal(g))), 0.5);
  const pLabel = PERIOD_LABELS[period] || '1W';

  const inflow = groups.filter(g => getVal(g) >= 0).sort((a, b) => getVal(b) - getVal(a));
  const outflow = groups.filter(g => getVal(g) < 0).sort((a, b) => getVal(a) - getVal(b));

  // Update panel titles
  document.querySelector('#inflow-panel .flow-panel-title').innerHTML = `ğŸ”º GAINERS (${pLabel}+) <span class="count">${inflow.length}</span>`;
  document.querySelector('#outflow-panel .flow-panel-title').innerHTML = `ğŸ”» LOSERS (${pLabel}-) <span class="count">${outflow.length}</span>`;

  function renderRows(container, items, isPositive) {
    const el = document.getElementById(container);
    el.innerHTML = '';
    items.forEach(g => {
      const val = getVal(g);
      const pctWidth = Math.min(Math.abs(val) / maxAbs * 100, 100);
      const bg = heatColor(val, maxAbs);
      const bc = barColor(val, maxAbs);
      const tc = textColor(val, maxAbs);
      const flowStr = fmtDollar(g.tradingImpact);
      const flowBig = Math.abs(g.tradingImpact) >= 1e9 ? ' big' : '';
      const flowColor = g.tradingImpact > 0 ? '#4ade80' : g.tradingImpact < 0 ? '#f87171' : 'var(--text-dim)';

      const row = document.createElement('div');
      row.className = 'flow-row';
      row.style.background = bg;
      row.title = `${g.catLabel} > ${g.name}\n1D:${fmtPctPlain(g.d1)}% 1W:${fmtPctPlain(g.d5)}% 1M:${fmtPctPlain(g.d30)}%` +
        (g.d90!=null?` 3M:${fmtPctPlain(g.d90)}%`:'') + (g.d180!=null?` 6M:${fmtPctPlain(g.d180)}%`:'') + (g.d365!=null?` 1Y:${fmtPctPlain(g.d365)}%`:'');
      row.innerHTML = `
        <div class="grp-label"><span class="expand-icon">&#9654;</span><span class="icon">${g.icon}</span>${g.name}</div>
        <div class="bar-wrap">
          <div class="bar-fill" style="width:${pctWidth}%;background:${bc};${isPositive ? '' : 'margin-left:auto'}"></div>
        </div>
        <div class="pct-block">
          <div class="pct-main" style="color:${tc}">${fmtPctPlain(val)}%</div>
          <div class="est-flow${flowBig}" style="color:${flowColor}">${flowStr}</div>
        </div>
      `;

      const detail = document.createElement('div');
      detail.className = 'ticker-expand';
      const inner = document.createElement('div');
      inner.className = 'ticker-expand-inner';
      inner.innerHTML = buildTickerTable(g.tickers);
      detail.appendChild(inner);

      row.addEventListener('click', () => {
        const icon = row.querySelector('.expand-icon');
        detail.classList.toggle('open');
        icon.classList.toggle('open');
      });

      el.appendChild(row);
      el.appendChild(detail);
    });
  }

  renderRows('inflow-rows', inflow, true);
  renderRows('outflow-rows', outflow, false);
}

// Period selector event
document.getElementById('period-selector').addEventListener('click', (e) => {
  const btn = e.target.closest('.period-btn');
  if (!btn) return;
  document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderFlowScoreboard(null, btn.dataset.period);
  renderTopMovers(null, btn.dataset.period);
});

// â”€â”€ Top Movers Strip â”€â”€
let _cachedTopMovers = null;
const PERIOD_TO_COL = {d1:'1D %', d5:'1W %', d30:'1M %', d90:'3M %', d180:'6M %', d365:'1Y %'};

function renderTopMovers(topMovers, period) {
  if (topMovers) _cachedTopMovers = topMovers;
  const data = _cachedTopMovers;
  const el = document.getElementById('top-movers');
  if (!data) { el.style.display = 'none'; return; }

  period = period || _currentPeriod;
  const col = PERIOD_TO_COL[period] || '1W %';
  const pLabel = PERIOD_LABELS[period] || '1W';

  // ëª¨ë“  í‹°ì»¤ë¥¼ í•©ì³ì„œ ì„ íƒëœ ê¸°ê°„ ê¸°ì¤€ìœ¼ë¡œ ì¬ì •ë ¬
  const all = [...(data.gainers || []), ...(data.losers || [])].filter(m => m[col] != null && !isNaN(m[col]));
  if (all.length === 0) { el.style.display = 'none'; return; }

  all.sort((a, b) => (b[col] || 0) - (a[col] || 0));
  const n = Math.min(5, Math.floor(all.length / 2)) || 1;
  const gainers = all.slice(0, n);
  const losers = all.slice(-n).reverse();

  let html = `<div class="top-movers-label">TOP MOVERS (${pLabel})</div>`;

  gainers.forEach(m => {
    const v = m[col] || 0;
    const bg = heatColor(v, 8);
    const tc = textColor(v, 8);
    html += `<div class="mover-card" style="background:${bg}">
      <div class="ticker" style="color:${tc}">${m.Ticker}</div>
      <div class="pct" style="color:#4ade80">${fmtPctPlain(v)}%</div>
      <div class="name">${m.Name || ''}</div>
    </div>`;
  });

  if (gainers.length > 0 && losers.length > 0) {
    html += '<div class="mover-spacer">|</div>';
  }

  losers.forEach(m => {
    const v = m[col] || 0;
    const bg = heatColor(v, 8);
    const tc = textColor(v, 8);
    html += `<div class="mover-card" style="background:${bg}">
      <div class="ticker" style="color:${tc}">${m.Ticker}</div>
      <div class="pct" style="color:#f87171">${fmtPctPlain(v)}%</div>
      <div class="name">${m.Name || ''}</div>
    </div>`;
  });

  el.innerHTML = html;
}

// â”€â”€ KPI Cards â”€â”€
function renderKPI(kpi) {
  const rs = kpi.rotation_score;
  if (rs != null) {
    const el = document.getElementById('kpi-rot');
    el.textContent = `${rs > 0 ? '+' : ''}${rs.toFixed(1)}`;
    el.style.color = rs > 3 ? 'var(--red)' : rs > 0 ? 'var(--yellow)' : 'var(--green)';
    document.getElementById('kpi-rot-sub').textContent = rs > 3 ? 'G->V ë¡œí…Œì´ì…˜ ê°€ì†' : rs > 0 ? 'ì•½í•œ ë¡œí…Œì´ì…˜' : 'V->G ë³µê·€';
    const bar = document.getElementById('kpi-rot-bar');
    bar.style.width = `${Math.min(Math.abs(rs)*10,100)}%`;
    bar.style.background = rs > 3 ? 'var(--red)' : rs > 0 ? 'var(--yellow)' : 'var(--green)';
  }

  const em = kpi.em_relative_5d;
  if (em != null) {
    const el = document.getElementById('kpi-em');
    el.textContent = `${em > 0 ? '+' : ''}${em.toFixed(1)}%`;
    el.style.color = em < -2 ? 'var(--red)' : 'var(--green)';
    document.getElementById('kpi-em-sub').textContent = em < -2 ? 'í•œêµ­ EM ëŒ€ë¹„ ì•½ì„¸' : 'í•œêµ­ ìƒëŒ€ ê°•ì„¸';
    const bar = document.getElementById('kpi-em-bar');
    bar.style.width = `${Math.min(Math.abs(em)*8,100)}%`;
    bar.style.background = em < -2 ? 'var(--red)' : 'var(--green)';
  }

  const vix = kpi.vix;
  if (vix != null) {
    const el = document.getElementById('kpi-vix');
    el.textContent = vix.toFixed(0);
    el.style.color = vix > 25 ? 'var(--red)' : vix > 20 ? 'var(--yellow)' : 'var(--green)';
    document.getElementById('kpi-vix-sub').textContent = vix > 25 ? 'ê³µí¬ êµ¬ê°„' : vix > 20 ? 'ê²½ê³„ êµ¬ê°„' : 'ì•ˆì •';
    const bar = document.getElementById('kpi-vix-bar');
    bar.style.width = `${Math.min(vix*3,100)}%`;
    bar.style.background = vix > 25 ? 'var(--red)' : vix > 20 ? 'var(--yellow)' : 'var(--green)';
  }

  const cs = kpi.hyg_lqd_spread_5d;
  if (cs != null) {
    const el = document.getElementById('kpi-credit');
    el.textContent = `${cs > 0 ? '+' : ''}${cs.toFixed(1)}%`;
    el.style.color = cs < -1.5 ? 'var(--red)' : cs < -0.5 ? 'var(--yellow)' : 'var(--green)';
    document.getElementById('kpi-credit-sub').textContent = cs < -1.5 ? 'í¬ë ˆë”§ ìŠ¤íŠ¸ë ˆìŠ¤' : cs < -0.5 ? 'ìŠ¤í”„ë ˆë“œ í™•ëŒ€ ì¤‘' : 'ì•ˆì •';
    const bar = document.getElementById('kpi-credit-bar');
    bar.style.width = `${Math.min(Math.abs(cs)*20,100)}%`;
    bar.style.background = cs < -1.5 ? 'var(--red)' : cs < -0.5 ? 'var(--yellow)' : 'var(--green)';
  }

  const usex = kpi.spy_vs_efa_5d;
  if (usex != null) {
    const el = document.getElementById('kpi-usex');
    el.textContent = `${usex > 0 ? '+' : ''}${usex.toFixed(1)}%`;
    el.style.color = usex > 3 ? 'var(--red)' : usex > 1 ? 'var(--yellow)' : 'var(--green)';
    document.getElementById('kpi-usex-sub').textContent = usex > 3 ? 'ë¯¸êµ­ ë…ì£¼ (EM ìœ„í—˜)' : usex > 1 ? 'ë¯¸êµ­ ì•½ê°„ ìš°ìœ„' : 'ê¸€ë¡œë²Œ ê· í˜•';
    const bar = document.getElementById('kpi-usex-bar');
    bar.style.width = `${Math.min(Math.abs(usex)*15,100)}%`;
    bar.style.background = usex > 3 ? 'var(--red)' : usex > 1 ? 'var(--yellow)' : 'var(--green)';
  }
}

// â”€â”€ Signals â”€â”€
function renderSignals(signals) {
  const div = document.getElementById('signals');
  div.innerHTML = '';
  if (!signals || signals.length === 0) {
    div.innerHTML = '<div class="signal-card signal-low"><div class="signal-icon">&#x1F7E2;</div><div class="signal-text"><strong>ì‹œê·¸ë„ ì—†ìŒ</strong></div></div>';
    return;
  }
  signals.forEach(s => {
    const lvl = (s.level||'').includes('HIGH') ? 'high' : (s.level||'').includes('MED') ? 'med' : 'low';
    const icon = lvl === 'high' ? 'ğŸ”´' : lvl === 'med' ? 'ğŸŸ¡' : 'ğŸŸ¢';
    div.innerHTML += `
      <div class="signal-card signal-${lvl}">
        <div class="signal-icon">${icon}</div>
        <div class="signal-text">
          <strong>${s.signal||''}</strong>
          <div class="detail">${s.implication||''}</div>
          ${s.data ? `<div class="detail" style="margin-top:2px">${s.data}</div>` : ''}
        </div>
      </div>`;
  });
}

// â”€â”€ Category Detail (collapsible, merged bonds_fx into risk_macro) â”€â”€
const CAT_DISPLAY_ORDER = ['us_sectors', 'regional', 'thematic', 'risk_macro', 'bonds_fx'];

function renderCategoryDetail(categories) {
  const section = document.getElementById('cat-detail-section');
  section.innerHTML = '';

  // Outer wrapper
  const wrapper = document.createElement('div');
  wrapper.className = 'cat-detail-wrapper';

  // Header with toggle
  const header = document.createElement('div');
  header.className = 'cat-detail-header';
  header.innerHTML = `
    <div class="cat-detail-title">ğŸ“Š ì¹´í…Œê³ ë¦¬ ë””í…Œì¼</div>
    <div class="cat-detail-toggle" id="cat-detail-toggle-text">â–¸ í¼ì¹˜ê¸°</div>
  `;
  wrapper.appendChild(header);

  // Badge summary (always visible)
  const badges = document.createElement('div');
  badges.className = 'cat-detail-badges';
  CAT_DISPLAY_ORDER.forEach(catKey => {
    const cat = categories[catKey];
    if (!cat) return;
    const summary = cat.summary || {};
    for (const [grpName, vals] of Object.entries(summary)) {
      const d5 = vals['1W %'] ?? 0;
      const bg = heatColor(d5, 5);
      const tc = textColor(d5, 5);
      badges.innerHTML += `<span class="cat-badge" style="background:${bg};color:${tc}">${cat.icon || ''} ${grpName} ${fmtPctPlain(d5)}%</span>`;
    }
  });
  wrapper.appendChild(badges);

  // Collapsible body
  const body = document.createElement('div');
  body.className = 'cat-detail-body';
  body.id = 'cat-detail-body';

  const inner = document.createElement('div');
  inner.className = 'cat-detail-inner';

  CAT_DISPLAY_ORDER.forEach(catKey => {
    const cat = categories[catKey];
    if (!cat) return;

    const card = document.createElement('div');
    card.className = 'cat-card-inner';

    card.innerHTML = `<div class="cat-label">${cat.icon || ''} ${cat.label}</div>`;

    const groups = cat.groups || {};
    const summary = cat.summary || {};

    for (const [grpName, tickers] of Object.entries(groups)) {
      if (!tickers || tickers.length === 0) continue;

      const sec = document.createElement('div');
      sec.className = 'group-section';

      const grpAvg = summary[grpName];
      const avgStr = grpAvg ? `1D:${fmtPctPlain(grpAvg['1D %'])} / 1W:${fmtPctPlain(grpAvg['1W %'])} / 1M:${fmtPctPlain(grpAvg['1M %'])}` + (grpAvg['3M %']!=null?` / 3M:${fmtPctPlain(grpAvg['3M %'])}`:'') : '';

      const gh = document.createElement('div');
      gh.className = 'group-header';
      gh.innerHTML = `<span class="toggle-icon open">&#9654;</span> ${grpName} <span class="grp-avg">${avgStr}</span>`;

      const gb = document.createElement('div');
      gb.className = 'group-body';
      gb.style.maxHeight = '500px';

      let tableHtml = `<table class="ticker-table">
        <thead><tr><th>Ticker</th><th class="ticker-name">Name</th><th class="num">1D</th><th class="num">1W</th><th class="num">1M</th><th class="num">3M</th><th class="num">6M</th><th class="num">1Y</th></tr></thead>
        <tbody>`;

      tickers.forEach(t => {
        const d1w = t['1W %'];
        const bgStyle = `background:${heatColor(d1w, 5)}`;
        const pctCols = ['1D %','1W %','1M %','3M %','6M %','1Y %'];
        tableHtml += `<tr style="${bgStyle}">
          <td><strong>${t.Ticker||''}</strong></td>
          <td class="ticker-name">${t.Name||''}</td>`;
        pctCols.forEach(c => { tableHtml += `<td class="num">${fmtPct(t[c])}</td>`; });
        tableHtml += `</tr>`;
      });

      tableHtml += '</tbody></table>';
      gb.innerHTML = tableHtml;

      gh.addEventListener('click', () => {
        const icon = gh.querySelector('.toggle-icon');
        if (gb.style.maxHeight === '0px') {
          gb.style.maxHeight = '500px';
          icon.classList.add('open');
        } else {
          gb.style.maxHeight = '0px';
          icon.classList.remove('open');
        }
      });

      sec.appendChild(gh);
      sec.appendChild(gb);
      card.appendChild(sec);
    }

    inner.appendChild(card);
  });

  body.appendChild(inner);
  wrapper.appendChild(body);

  // Toggle behavior
  header.addEventListener('click', () => {
    const toggleText = document.getElementById('cat-detail-toggle-text');
    if (body.classList.contains('open')) {
      body.classList.remove('open');
      toggleText.textContent = 'â–¸ í¼ì¹˜ê¸°';
    } else {
      body.classList.add('open');
      toggleText.textContent = 'â–¾ ì ‘ê¸°';
    }
  });

  section.appendChild(wrapper);
}

// â”€â”€ Group TE (dual: {price: {1M:[], ...}, flow: {1M:[], ...}}) â”€â”€
function renderGroupTE(teData) {
  if (!teData || typeof teData !== 'object') return;
  const card = document.getElementById('group-te-card');
  const grid = document.getElementById('group-te-grid');
  const windowOrder = ['2W', '1M', '3M', '6M'];
  const windowLabels = {'2W': '2ì£¼ (10ì¼)', '1M': '1ê°œì›” (21ì¼)', '3M': '3ê°œì›” (63ì¼)', '6M': '6ê°œì›” (126ì¼)'};

  // Dual mode: {price: {...}, flow: {...}} or legacy single mode
  const priceData = teData.price || teData;
  const flowData = teData.flow || {};
  const hasDual = !!teData.price;

  let hasData = false;
  let gridHtml = '';

  function buildRows(rows, colorScheme) {
    if (!rows || rows.length === 0) return '';
    const maxZ = Math.max(...rows.map(t => t.net_z), 3);
    let html = '';
    rows.forEach(t => {
      const pct = Math.min(t.net_z / maxZ * 100, 100);
      let color;
      if (colorScheme === 'price') {
        color = t.net_z > 4 ? '#f87171' : t.net_z > 2.5 ? '#fbbf24' : '#60a5fa';
      } else {
        color = t.net_z > 4 ? '#c084fc' : t.net_z > 2.5 ? '#a78bfa' : '#22d3ee';
      }
      html += `<div class="te-flow-row">
        <div class="te-dir" style="color:${color}">${t.direction}</div>
        <div class="te-z" style="color:${color}">Z=${t.net_z > 0 ? '+' : ''}${t.net_z.toFixed(1)}</div>
        <div class="te-lag">lag ${t.lag}</div>
        <div class="te-bar"><div class="te-bar-fill" style="width:${pct}%;background:${color}"></div></div>
      </div>`;
    });
    return html;
  }

  windowOrder.forEach(key => {
    const pRows = priceData[key] || [];
    const fRows = flowData[key] || [];
    if (pRows.length === 0 && fRows.length === 0) {
      gridHtml += `<div class="te-panel">
        <div class="te-panel-title">${windowLabels[key] || key}</div>
        <div style="color:var(--text-muted);font-size:10px;padding:8px 0">ë°ì´í„° ë¶€ì¡±</div>
      </div>`;
      return;
    }
    hasData = true;
    let panelHtml = `<div class="te-panel"><div class="te-panel-title">${windowLabels[key] || key}</div>`;
    if (pRows.length > 0) {
      panelHtml += `<div class="te-section-label" style="color:#60a5fa">Price</div>`;
      panelHtml += buildRows(pRows, 'price');
    }
    if (hasDual && fRows.length > 0) {
      panelHtml += `<div class="te-section-label" style="color:#22d3ee">Flow</div>`;
      panelHtml += buildRows(fRows, 'flow');
    } else if (hasDual && fRows.length === 0) {
      panelHtml += `<div class="te-section-label" style="color:var(--text-muted)">Flow â€” ë¶€ì¡±</div>`;
    }
    panelHtml += `</div>`;
    gridHtml += panelHtml;
  });

  if (hasData) {
    card.hidden = false;
    grid.innerHTML = gridHtml;
  }
}

// â”€â”€ Buying Efficiency â”€â”€
function renderBuyingEfficiency(be) {
  if (!be || be.error) return;
  const card = document.getElementById('buying-eff-card');
  const content = document.getElementById('buying-eff-content');
  card.hidden = false;

  const chgArrow = be.kospi_change > 0 ? 'â–²' : be.kospi_change < 0 ? 'â–¼' : '--';
  const chgColor = be.kospi_change > 0 ? 'var(--green)' : be.kospi_change < 0 ? 'var(--red)' : 'var(--text-dim)';
  let effLabel = '', effColor = 'var(--text-dim)';
  if (be.efficiency != null) {
    if (be.efficiency > 0) { effLabel = 'íš¨ìœ¨ì '; effColor = 'var(--green)'; }
    else if (be.efficiency > -5) { effLabel = 'ì™¸ì¸ ë§¤ë„ ìƒì‡„ ì¤‘'; effColor = 'var(--yellow)'; }
    else { effLabel = 'ë°©ì–´ ì‹¤íŒ¨'; effColor = 'var(--red)'; }
  }

  let html = `<span style="color:var(--text-dim)">${be.date}</span> | `;
  html += `ì½”ìŠ¤í”¼ <strong>${Number(be.kospi_close).toLocaleString()}</strong> <span style="color:${chgColor}">${chgArrow}${be.kospi_change > 0 ? '+' : ''}${be.kospi_change}p</span> | `;
  html += `ê°œì¸ <strong>${be.individual_net_buy > 0 ? '+' : ''}${be.individual_net_buy}ì¡°</strong>`;
  if (be.foreign_net_buy != null) {
    const fc = be.foreign_net_buy > 0 ? 'var(--green)' : 'var(--red)';
    html += ` | <span style="color:${fc}">ì™¸ì¸ ${be.foreign_net_buy > 0 ? '+' : ''}${be.foreign_net_buy}ì¡°</span>`;
  }
  if (be.efficiency != null) {
    html += ` | íš¨ìœ¨ <strong style="color:${effColor}">${be.efficiency > 0 ? '+' : ''}${be.efficiency}</strong> (${effLabel})`;
  }
  content.innerHTML = html;
}

// â”€â”€ Timestamp â”€â”€
function showTimestamp(generatedAt, dataDate) {
  const ts = document.getElementById('timestamp');
  const dd = document.getElementById('data-date');
  const now = new Date();
  ts.textContent = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')} KST`;
  if (dataDate) dd.textContent = `ë°ì´í„° ê¸°ì¤€: ${dataDate}`;
  if (generatedAt) dd.textContent += ` | ìƒì„±: ${generatedAt}`;
}

// ===================== MAIN: Load JSON =====================
fetch('./flow_monitor_latest.json?t=' + Date.now())
  .then(res => {
    if (!res.ok) throw new Error('JSON not found');
    return res.json();
  })
  .then(data => {
    showTimestamp(data.generated_at, data.data_date);

    if (data.categories) {
      renderFlowScoreboard(data.categories);
      renderCategoryDetail(data.categories);
    }

    if (data.top_movers) renderTopMovers(data.top_movers);
    if (data.kpi) renderKPI(data.kpi);
    renderSignals(data.signals);
    if (data.group_te) renderGroupTE(data.group_te);
    renderBuyingEfficiency(data.buying_efficiency);

    // Footer
    const footer = document.getElementById('footer-note');
    if (footer) {
      footer.innerHTML = `ë°ì´í„° ì—°ë™ ì™„ë£Œ | ${data.generated_at || ''} | ${data.data_date || 'N/A'}<br>` + footer.innerHTML;
    }
  })
  .catch(() => {
    showTimestamp(null, null);
    document.getElementById('timestamp').textContent += ' | JSON ë¯¸ë°œê²¬';
    document.getElementById('signals').innerHTML = `
      <div class="signal-card signal-med">
        <div class="signal-icon">&#x26A0;&#xFE0F;</div>
        <div class="signal-text">
          <strong>ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong>
          <div class="detail">
            <code>python global_flow_monitor.py</code> ë¥¼ ì‹¤í–‰í•œ ë’¤ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš” (ìë™ export).<br>
            flow_monitor_latest.json íŒŒì¼ì´ ì´ HTMLê³¼ ê°™ì€ í´ë”ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
          </div>
        </div>
      </div>`;
  });
</script>
</body>
</html>
